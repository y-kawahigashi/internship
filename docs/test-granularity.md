# テストケースの粒度の考え方

## テストの種類と粒度

### 単体テスト（Unit Test）

**目的**: 1 つの関数やメソッドが正しく動作することを確認する

**粒度の考え方**:

- **細かく**: 1 つの関数に対して、複数のテストケースを書く
- **1 つのテストケース = 1 つの動作確認**
- 正常系・異常系・エッジケースを分けて書く

**例**: バリデーション関数のテスト

```typescript
describe("CreateEventParamsSchema", () => {
  describe("nameのバリデーション", () => {
    it("nameが未指定の場合は無効", () => {
      /* ... */
    });
    it("nameが空文字列の場合は無効", () => {
      /* ... */
    });
    it("nameが201文字の場合は無効", () => {
      /* ... */
    });
  });

  describe("capacityのバリデーション", () => {
    it("capacityが0の場合は無効", () => {
      /* ... */
    });
    it("capacityが負の数の場合は無効", () => {
      /* ... */
    });
  });
});
```

**ポイント**:

- 1 つのバリデーションルール = 1 つのテストケース
- エラーメッセージも個別に確認
- テストが失敗した時に、どのルールが問題かすぐ分かる

---

### 結合テスト（Integration Test）

**目的**: 複数のコンポーネント（Service、Repository、データベースなど）が連携して正しく動作することを確認する

**粒度の考え方**:

- **粗く**: 1 つのユースケース（機能）に対して、いくつかのテストケースを書く
- **1 つのテストケース = 1 つのユースケースの確認**
- 正常系と主要な異常系を確認

**例**: イベント作成機能のテスト

```typescript
describe("EventService", () => {
  describe("createEvent", () => {
    it("イベントを作成できること", async () => {
      // Service → Repository → データベース の流れを確認
      const event = await eventService.createEvent({
        /* ... */
      });
      expect(event).toBeDefined();
      expect(event.id).toBeDefined();
      // ...
    });

    it("説明がnullのイベントを作成できること", async () => {
      // オプショナルフィールドの確認
      // ...
    });
  });
});
```

**ポイント**:

- データベースとの連携を含めて確認
- 複数のレイヤー（Service、Repository）が協調して動作することを確認
- 細かいバリデーションエラーは単体テストで確認済みなので、ここでは確認しない

---

## 粒度の判断基準

### 単体テストを細かく書くべき場合

✅ **細かく書く**:

- バリデーション関数（各ルールごとにテスト）
- ユーティリティ関数（各エッジケースごとにテスト）
- 計算ロジック（各計算パターンごとにテスト）

❌ **細かく書かない**:

- データベースアクセスを含む処理（結合テストで確認）
- 複数のレイヤーをまたぐ処理（結合テストで確認）

### 結合テストを細かく書くべき場合

✅ **細かく書く**:

- 主要なユースケース（正常系）
- ビジネスロジックの重要な分岐
- エラーハンドリングの主要なパターン

❌ **細かく書かない**:

- バリデーションの細かいルール（単体テストで確認済み）

---

## まとめ

| 項目             | 単体テスト                         | 結合テスト                 |
| ---------------- | ---------------------------------- | -------------------------- |
| **粒度**         | 細かい（1 関数 = 複数テスト）      | 粗い（1 機能 = 数テスト）  |
| **対象**         | 1 つの関数・メソッド               | 複数のコンポーネントの連携 |
| **確認内容**     | 正常系・異常系・エッジケースすべて | 主要なユースケース         |
| **失敗時の情報** | どのルール・条件が問題か明確       | どの機能が問題か明確       |

**覚えておくこと**:

- 単体テストは「細かく、網羅的に」
- 結合テストは「粗く、主要な流れを」
- 両方で重複してテストする必要はない（単体テストで確認した細かい内容は結合テストでは省略可）
